<div class="header-bar">
  <div>
    <p class="pill">Gramola</p>
    <h2>Panel de control</h2>
    <p class="muted">Gestiona canciones, dispositivos y playlists del local.</p>
  </div>
  <div class="header-actions">
    <span *ngIf="currentDevice" class="chip">Conectado: {{ currentDevice.name }}</span>
    <img [src]="userSignature" alt="Firma del dueño" style="height: 46px; border: 1px solid var(--border); border-radius: 8px;">
    <button class="btn btn-ghost" (click)="logout()">Cerrar sesión</button>
  </div>
</div>

<div class="music-grid">
  <!-- Paneles con busqueda, dispositivos, playlists y cola -->
  <div class="card">
    <div class="section-title">
      <h3>Buscar canción</h3>
    </div>
    <div class="search-input">
      <input type="text" [(ngModel)]="searchTerm" placeholder="Título o artista..." (keyup.enter)="buscar()">
      <button class="btn" (click)="buscar()">Buscar</button>
    </div>

    <div class="results-list" *ngIf="tracks.length > 0">
      <div class="track-item" *ngFor="let track of tracks">
        <img [src]="track.album.images[2]?.url" alt="Cover">
        <div class="track-info">
          <strong>{{ track.name }}</strong>
          <span>{{ track.artists[0].name }}</span>
        </div>
        <button class="btn btn-secondary" (click)="solicitarCancion(track)">
          Poner ({{ songPriceCents != null ? (songPriceCents / 100) : '?' }} €)
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="successMsg" class="msg success">{{ successMsg }}</div>
  <div *ngIf="errorMsg" class="msg error">{{ errorMsg }}</div>

  <div class="card">
    <div class="section-title">
      <h3>Dispositivos</h3>
      <button class="btn btn-ghost" (click)="cargarDispositivos()">Recargar</button>
    </div>
    <p class="muted">{{ currentDevice ? 'Conectado: ' + currentDevice.name : 'Ningún dispositivo activo' }}</p>
    <div *ngIf="devices.length === 0">
      <p class="muted">Abre Spotify en este equipo y prueba de nuevo.</p>
    </div>
    <ul class="device-list">
      <li class="device-item" *ngFor="let device of devices" [class.active]="device.is_active">
        <strong>{{ device.name }}</strong> ({{ device.type }})
        <span *ngIf="device.is_active"> · Sonando ahora</span>
      </li>
    </ul>
  </div>

  <div class="card">
    <div class="section-title">
      <h3>Playlists del local</h3>
    </div>
    <div class="playlist-grid">
      <div class="playlist-item" *ngFor="let list of playlists">
        <img *ngIf="list.images.length > 0" [src]="list.images[0].url" alt="playlist cover">
        <p>{{ list.name }}</p>
        <button class="btn btn-secondary" (click)="reproducirPlaylist(list)">Reproducir en {{ currentDevice?.name || 'dispositivo activo' }}</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">
      <h3>Playlist en reproducción</h3>
      <div>
        <button class="btn btn-ghost" (click)="cargarPlaybackActual()">Refrescar</button>
        <button class="btn btn-ghost" *ngIf="!isPlaying && currentDevice" (click)="reanudarReproduccion()">Reanudar en {{ currentDevice?.name }}</button>
      </div>
    </div>
    <ng-container *ngIf="currentPlaylistName; else noPlaylist">
      <p class="muted">Sonando: <strong>{{ currentPlaylistName }}</strong></p>
      <ul class="queue-list">
        <li class="queue-item" *ngFor="let track of currentPlaylistTracks">
          {{ track?.name }} - {{ track?.artists?.[0]?.name }}
        </li>
      </ul>
    </ng-container>
    <ng-template #noPlaylist>
      <p class="muted">Aun no hay playlist activa. Elige una para reproducir.</p>
    </ng-template>
  </div>

  <div class="card">
    <div class="section-title">
      <h3>Cola actual</h3>
      <button class="btn btn-ghost" (click)="cargarCola()">Recargar cola</button>
    </div>
    <div *ngIf="nowPlaying">
      <p>Reproduciendo: <strong>{{ nowPlaying?.name }}</strong> - {{ nowPlaying?.artists?.[0]?.name }}</p>
    </div>
    <ul class="queue-list">
      <li class="queue-item" *ngFor="let item of queue">
        {{ item.name }} - {{ item.artists?.[0]?.name }}
      </li>
    </ul>
  </div>
</div>

<div class="modal-overlay" *ngIf="confirmandoPlaylist">
  <div class="modal-content">
    <h3>Verificacion de empleado</h3>
    <p class="muted">Introduce la contraseña del bar para reproducir: <strong>{{ playlistObjetivo?.name }}</strong></p>

    <div class="auth-box">
      <label for="playlist-pass">Contraseña</label>
      <input id="playlist-pass" type="password" [(ngModel)]="playlistPassword" placeholder="Contraseña del bar" (keyup.enter)="confirmarReproduccionPlaylist()">
    </div>

    <div *ngIf="playlistError" class="msg error">{{ playlistError }}</div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="cancelarConfirmacionPlaylist()" [disabled]="verificandoPlaylist">Cancelar</button>
      <button class="btn-pay" (click)="confirmarReproduccionPlaylist()" [disabled]="verificandoPlaylist">
        {{ verificandoPlaylist ? 'Verificando...' : 'Autorizar y reproducir' }}
      </button>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="pagandoCancion">
  <!-- Modal de pago por cancion individual -->
  <div class="modal-content">
    <h3>Confirmar pedido</h3>
    <p>Vas a poner: <strong>{{ cancionSeleccionada?.name }}</strong></p>
    <p>Precio: <strong>{{ songPriceCents != null ? (songPriceCents / 100) : '?' }} €</strong></p>

    <div class="stripe-box">
      <div id="card-element-song"></div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="cancelarPago()">Cancelar</button>
      <button class="btn-pay" (click)="confirmarPago()">Pagar y sonar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="mostrandoModalUbicacion">
  <div class="modal-content">
    <h3>{{ tituloModalUbicacion }}</h3>
    <p class="muted">{{ mensajeModalUbicacion }}</p>

    <div class="modal-actions">
      <button class="btn-pay" (click)="cerrarModalUbicacion()">Entendido</button>
    </div>
  </div>
</div>

